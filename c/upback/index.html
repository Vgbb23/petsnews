<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Que tal fazer um pouquinho mais?</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Roboto:wght@300;400;500;600;700;800&family=Montserrat:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Roboto, sans-serif;
        background-color: #ffffff;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 16px;
        text-align: center;
        box-sizing: border-box;
      }

      h1 {
        font-family: Poppins, sans-serif;
        font-size: 1.8em;
        color: #000000;
        margin-bottom: 20px;
      }

      p {
        font-size: 1em;
        color: #939191;
        margin-bottom: 20px;
        text-align: left;
        max-width: 90%;
        margin-left: auto;
        margin-right: auto;
      }

      .buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
      }

      .button {
        background: #35cb4a;
        border-radius: 4px;
        border: none;
        color: #ffffff;
        padding: 16px 32px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.5s ease-in-out;
        text-decoration: none;
        font-family: Montserrat, sans-serif;
        margin-top: 20px;
        width: 100%;
        max-width: 90%px;
      }

      .button:hover {
        filter: brightness(1.2);
      }

      .reject-link {
        color: #939191;
        text-decoration: none;
        font-size: 14px;
        margin-top: 10px;
        cursor: pointer;
        display: block;
      }

      .reject-link:hover {
        text-decoration: underline;
      }

      @media (max-width: 640px) {
        .container {
          padding: 16px;
          margin: 0;
          width: 100%;
        }

        .custom-value-input {
          padding: 16px;
          margin: 0;
          border-radius: 12px;
        }

        .value-input {
          font-size: 20px;
          padding: 12px;
        }

        .generate-button {
          margin: 16px 0;
          width: 100%;
        }
      }

      .input-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        margin: 16px auto;
        width: 100%;
        max-width: 100%;
        padding: 0 16px;
        box-sizing: border-box;
      }

      .preset-values {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
      }

      .preset-button:last-child {
        grid-column: auto;
      }

      .preset-button {
        width: 100%;
        padding: 12px;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        background: #fff;
        color: #333;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .preset-button .amount {
        color: #35cb4a;
        font-size: 16px;
        font-weight: 600;
        font-family: "Poppins", sans-serif;
      }

      .preset-button span:last-child {
        color: #666;
        font-size: 12px;
      }

      .preset-button:hover {
        border-color: #35cb4a;
        background: #f8fff9;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(53, 203, 74, 0.15);
      }

      .preset-button.selected {
        border-color: #35cb4a;
        background: #f8fff9;
        box-shadow: 0 2px 6px rgba(53, 203, 74, 0.2);
      }

      .custom-value-input {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 24px;
        background: #ffffff;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        box-sizing: border-box;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .custom-value-input h2 {
        text-align: center;
        color: #000000;
        font-size: 22px;
        margin: 0 0 24px;
        font-weight: 600;
        font-family: Poppins, sans-serif;
      }

      .value-input {
        width: 100%;
        max-width: 100%;
        padding: 16px;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        font-size: 24px;
        text-align: center;
        color: #000000;
        font-weight: 500;
        font-family: "Poppins", sans-serif;
        box-sizing: border-box;
        background: #f8f8f8;
      }

      .value-input:focus {
        outline: none;
        border-color: #35cb4a;
        box-shadow: 0 2px 8px rgba(53, 203, 74, 0.15);
        background: #ffffff;
      }

      .value-input::placeholder {
        color: #939191;
        font-weight: 400;
      }

      .shortcuts {
        text-align: center;
      }

      .shortcuts-label {
        color: #939191;
        font-size: 14px;
        margin: 16px 0 8px;
        font-weight: 500;
        font-family: Roboto, sans-serif;
      }

      .shortcuts-grid {
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
        padding: 0 8px;
        box-sizing: border-box;
      }

      .shortcut-chip {
        padding: 8px 16px;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        background: #fff;
        color: #000000;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: Montserrat, sans-serif;
      }

      .shortcut-chip:hover {
        border-color: #35cb4a;
        background: #f8fff9;
        color: #35cb4a;
      }

      .error-message {
        color: #dc3545;
        font-size: 13px;
        margin-top: 12px;
        text-align: center;
        background: #fff;
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid #ffebeb;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.1);
        font-family: Roboto, sans-serif;
      }

      .generate-button {
        width: 100%;
        max-width: 100%;
        margin: 0;
        background: #35cb4a;
        border-radius: 8px;
        border: none;
        color: #ffffff;
        padding: 16px 32px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: Montserrat, sans-serif;
        box-shadow: 0 2px 8px rgba(53, 203, 74, 0.2);
      }

      .generate-button:hover {
        background: #2fb840;
        box-shadow: 0 12px 32px rgba(53, 203, 74, 0.25);
        transform: translateY(-2px);
      }

      .generate-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .pix-area {
        width: 100%;
        max-width: 90%;
        margin: 20px auto;
      }

      .pix-container {
        background: #ffffff;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .pix-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .pix-header h3 {
        margin: 0;
        font-size: 16px;
        color: #333;
        font-weight: 600;
      }

      .pix-icon {
        width: 24px;
        height: 24px;
      }

      .pix-code-container {
        position: relative;
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .pix-code {
        width: 90%;
        height: 60px;
        padding: 8px 12px;
        background: #f8f8f8;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        font-family: monospace;
        font-size: 14px;
        resize: none;
        margin-bottom: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #333;
        letter-spacing: 0.5px;
      }

      .copy-button {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px;
        background: #35cb4a;
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .copy-button:hover {
        background: #2fb840;
      }

      .copy-icon {
        width: 20px;
        height: 20px;
      }

      .pix-info {
        margin: 0;
        font-size: 14px;
        color: #666;
        text-align: center;
        line-height: 1.4;
      }

      .value-input::-webkit-input-placeholder {
        color: #666;
      }

      .value-input::-webkit-outer-spin-button,
      .value-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .value-input[type="number"] {
        -webkit-appearance: textfield;
        -moz-appearance: textfield;
        appearance: textfield;
      }

      .currency-prefix {
        display: none;
      }

      .loading-container {
        width: 100%;
        max-width: 300px;
        margin: 20px auto;
        text-align: center;
      }

      .loading-content {
        background: #ffffff;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        margin: 0 auto 16px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #35cb4a;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .loading-content p {
        margin: 0;
        color: #666;
        font-size: 14px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 640px) {
        .custom-value-input {
          padding: 16px;
        }

        .custom-value-input h2 {
          font-size: 20px;
          margin: 0 0 16px;
        }

        .value-input {
          font-size: 20px;
          padding: 12px;
        }

        .shortcuts-label {
          margin: 12px 0 8px;
        }

        .generate-button {
          padding: 14px 24px;
          font-size: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <img
        src="./images/vgif.gif"
        alt="Coração"
        style="max-width: 150px; margin-bottom: 10px"
      />

      <h1>Que tal fazer<br />um pouquinho mais?</h1>
      <p>⚠️ NÃO PODEMOS PERDER ESSA VIDA!</p>

      <p>
        Amanhã é o ÚLTIMO DIA para arrecadarmos o valor necessário e salvarmos
        essa vida preciosa! Estamos tão perto da meta, mas só chegaremos lá com
        sua ajuda.
      </p>

      <p>
        💗 Imagine a dor de perder uma chance tão importante por tão pouco. Não
        permita que isso aconteça. Cada segundo conta, e sua contribuição pode
        ser a chave para salvar uma vida!
      </p>

      <p>👉 Doe agora e seja o HERÓI que<br />essa pessoa tanto precisa!</p>

      <p>Escolha um dos três valores para acelerar o alcance da meta! 🙏</p>

      <div class="input-area">
        <div class="custom-value-input">
          <h2
            style="
              text-align: center;
              color: #333;
              font-size: 20px;
              margin: 0 0 24px;
              font-weight: 600;
            "
          >
            Digite o valor da sua doação
          </h2>
          <div class="value-input-wrapper">
            <input
              type="tel"
              inputmode="numeric"
              id="customValue"
              placeholder="R$ 0,00"
              class="value-input"
              pattern="[0-9]*"
            />
          </div>
          <div class="shortcuts">
            <p class="shortcuts-label">Atalhos rápidos:</p>
            <div class="shortcuts-grid">
              <button onclick="fillAmount(15)" class="shortcut-chip">
                R$ 15
              </button>
              <button onclick="fillAmount(20)" class="shortcut-chip">
                R$ 20
              </button>
              <button onclick="fillAmount(25)" class="shortcut-chip">
                R$ 25
              </button>
            </div>
          </div>
        </div>
        <button onclick="generatePix()" class="generate-button">
          Gerar PIX
        </button>
      </div>

      <div id="loadingPix" class="loading-container" style="display: none">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <p>Gerando código PIX...</p>
        </div>
      </div>

      <div id="pixArea" style="display: none" class="pix-area">
        <div class="pix-container">
          <div class="pix-header">
            <img
              src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIwLjI1IDQuNUg1LjI1QzQuMDA3MzYgNC41IDMgNS41MDczNiAzIDYuNzVWMTcuMjVDMyAxOC40OTI2IDQuMDA3MzYgMTkuNSA1LjI1IDE5LjVIMjAuMjVDMjEuNDkyNiAxOS41IDIyLjUgMTguNDkyNiAyMi41IDE3LjI1VjYuNzVDMjIuNSA1LjUwNzM2IDIxLjQ5MjYgNC41IDIwLjI1IDQuNVoiIHN0cm9rZT0iIzM1Y2I0YSIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTMgOC4yNUgyMi41IiBzdHJva2U9IiMzNWNiNGEiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cg=="
              alt="PIX Icon"
              class="pix-icon"
            />
            <h3>Código PIX gerado</h3>
          </div>
          <div class="pix-code-container">
            <textarea id="pixCode" readonly class="pix-code"></textarea>
            <button onclick="copyPixCode()" class="copy-button">
              <img
                src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIwIDlIMTFDOS44OTU0MyA5IDkgOS44OTU0MyA5IDExVjIwQzkgMjEuMTA0NiA5Ljg5NTQzIDIyIDExIDIySDIwQzIxLjEwNDYgMjIgMjIgMjEuMTA0NiAyMiAyMFYxMUMyMiA5Ljg5NTQzIDIxLjEwNDYgOSAyMCA5WiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxLjUiLz4KPHBhdGggZD0iTTUgMTVIM0MyLjQ0NzcyIDE1IDIgMTQuNTUyMyAyIDE0VjNDMiAyLjQ0NzcyIDIuNDQ3NzIgMiAzIDJIMTRDMTQuNTUyMyAyIDE1IDIuNDQ3NzIgMTUgM1Y1IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjEuNSIvPgo8L3N2Zz4K"
                alt="Copy"
                class="copy-icon"
              />
              Copiar código
            </button>
          </div>
          <p class="pix-info">
            Após copiar o código, abra o app do seu banco e escolha a opção PIX
            Copia e Cola
          </p>
        </div>
      </div>
    </div>

    
<script>
function formatCurrency(value) {
  return 'R$ ' + parseFloat(value).toFixed(2).replace('.', ',');
}

function unformatCurrency(value) {
  if (typeof value === "number") return value;
  return parseFloat(value.replace(/[^\d,]/g, "").replace(",", ".")) || 0;
}

function generateValidCPF() {
  const randomDigits = () => Math.floor(Math.random() * 10);
  const cpf = Array.from({ length: 9 }, randomDigits);
  const calc = (cpfArray, factor) => {
    const total = cpfArray.reduce((acc, num, idx) => acc + num * (factor - idx), 0);
    const rest = 11 - (total % 11);
    return rest >= 10 ? 0 : rest;
  };
  cpf.push(calc(cpf, 10));
  cpf.push(calc(cpf, 11));
  return cpf.join('');
}

function copyPixCode() {
  const pixCode = document.getElementById("pixCode");
  const temp = document.createElement("textarea");
  temp.value = pixCode.value;
  document.body.appendChild(temp);
  temp.select();
  document.execCommand("copy");
  document.body.removeChild(temp);
  const copyButton = document.querySelector(".copy-button");
  const originalText = copyButton.innerHTML;
  copyButton.innerHTML = "Copiado!";
  setTimeout(() => {
    copyButton.innerHTML = originalText;
  }, 2000);
}

function updateUI(pixCode) {
  document.getElementById("pixCode").value = pixCode;
  document.getElementById("pixArea").style.display = "block";
  document.getElementById("loadingPix").style.display = "none";
}

async function generatePix() {
  const input = document.getElementById("customValue");
  const customValue = input.value;
  const numValue = unformatCurrency(customValue);
  if (!customValue || numValue < 15) {
    alert("Digite um valor válido (mínimo R$ 15,00)");
    return;
  }

  const amount = parseFloat((numValue).toFixed(2));

  // Gerar um external_id único para a transação
  const externalId = "ext_" + Date.now() + Math.floor(Math.random() * 10000);
  const payload = {
    external_id: externalId,
    total_amount: amount,
    payment_method: "PIX",
    webhook_url: "https://oficial-lojasegura.site/webhook-rublion.php",
    items: [
      {
        id: "item1",
        title: "Renda extra Upsell",
        description: "Pagamento via PIX",
        price: amount,
        quantity: 1,
        is_physical: false
      }
    ],
    ip: "127.0.0.1", // Opcional: pode ser dinâmico se desejar
    customer: {
      name: "Cliente upsell",
      email: "doador@email.com",
      phone: "11999999999",
      document_type: "CPF",
      document: generateValidCPF(),
      utm_source: "site",
      utm_medium: "doacao",
      utm_campaign: "campanha",
      utm_content: "",
      utm_term: ""
    }
    // splits: [] // Adicione se necessário
  };

  try {
    document.querySelector(".input-area").style.display = "none";
    document.getElementById("loadingPix").style.display = "block";

    const response = await fetch("https://api.rublion.com.br/v1/transactions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "api-secret": "sk_4b65eed420ae704a69de809b325e8340c4f56a48e066b688aaafad55208c7e3d8eab735b2bade95863312885085438f146a7a17e0e27ed7e68a6177892e5bac1"
      },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    console.log("[Rublion] Status HTTP:", response.status);
    console.log("[Rublion] Resposta completa:", result);

    if (result && result.pix && result.pix.payload && result.id) {
      updateUI(result.pix.payload);
      startVerification(result.id);
    } else {
      if(result && result.hasError !== undefined) {
        console.error("[Rublion] Erro na resposta:", result);
      }
      throw new Error("Código PIX não gerado");
    }
  } catch (error) {
    alert("Erro ao gerar o PIX. Por favor, tente novamente.");
    console.error("Erro ao gerar PIX:", error);
    document.querySelector(".input-area").style.display = "flex";
    document.getElementById("loadingPix").style.display = "none";
  }
}

function startVerification(idTransaction) {
  const interval = setInterval(async () => {
    try {
      const verifyUrl = `https://api.rublion.com.br/v1/transactions/${idTransaction}`;
      const res = await fetch(verifyUrl, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "api-secret": "sk_4b65eed420ae704a69de809b325e8340c4f56a48e066b688aaafad55208c7e3d8eab735b2bade95863312885085438f146a7a17e0e27ed7e68a6177892e5bac1"
        }
      });
      const result = await res.json();
      console.log("[Rublion Consulta] Resposta:", result);
      if (result && result.status === "AUTHORIZED") {
        clearInterval(interval);
        // (Removido: chamada utmifyConversion para não marcar conversão no upsell)
        window.location.href = "../upback";
      }
    } catch (err) {
      console.log("[Rublion Consulta] Verificação falhou, tentando novamente...", err);
    }
  }, 5000);
}

document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("customValue");
  input.addEventListener("input", function (e) {
    let value = e.target.value.replace(/\D/g, "");
    value = (parseInt(value) / 100).toFixed(2);
    e.target.value = formatCurrency(value);
  });
});

function fillAmount(value) {
  const input = document.getElementById("customValue");
  input.value = formatCurrency(value);
}

// Sistema de Pixels do Facebook Unificado
(function() {
  // Carrega o sistema de pixels se não estiver carregado
  if (!window.FACEBOOK_PIXEL_CONFIG) {
    const configScript = document.createElement('script');
    configScript.src = '../pixel/config.js';
    document.head.appendChild(configScript);
    
    const eventsScript = document.createElement('script');
    eventsScript.src = '../pixel/events.js';
    document.head.appendChild(eventsScript);
  }
  
  // Dispara evento Purchase usando o sistema unificado
  function firePurchaseOnSuccess(attempt = 1) {
    try {
      var value = window.paymentAmount || null;
      var eventId = window.uniqueEventId || null;
      
      if (!value) {
        value = localStorage.getItem('lastPaymentAmount');
        if (value) value = parseFloat(value);
      }
      if (!eventId) {
        eventId = localStorage.getItem('lastEventId');
      }
      
      if (value && eventId) {
        // Usa o sistema unificado de pixels
        if (window.trackFacebookEvent) {
          window.trackFacebookEvent('Purchase', {
            value: value,
            currency: 'BRL',
            event_id: eventId
          });
          console.log('[PIXEL UNIFICADO] Evento Purchase disparado:', value, eventId);
        } else if (typeof fbq !== 'undefined') {
          // Fallback para fbq direto se necessário
          fbq('track', 'Purchase', {
            value: value,
            currency: 'BRL',
            num_items: 1,
            event_id: eventId
          });
          console.log('[PIXEL FALLBACK] Evento Purchase disparado:', value, eventId);
        }
      } else {
        if (attempt < 5) {
          setTimeout(function() { firePurchaseOnSuccess(attempt + 1); }, 400);
        } else {
          console.warn('[PIXEL] Não foi possível disparar evento Purchase.');
        }
      }
    } catch (e) {
      console.error('[PIXEL] Erro ao disparar evento Purchase:', e);
    }
  }
  
  // Salva valores no localStorage
  if (window.paymentAmount) localStorage.setItem('lastPaymentAmount', window.paymentAmount);
  if (window.uniqueEventId) localStorage.setItem('lastEventId', window.uniqueEventId);
  
  // Dispara evento ao carregar a página
  firePurchaseOnSuccess();
})();
</script>
</body>
</html>
